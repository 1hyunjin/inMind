{"ast":null,"code":"\"use strict\";\n\n/*\n * (C) Copyright 2017-2022 OpenVidu (https://openvidu.io)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Filter = void 0;\nvar StreamPropertyChangedEvent_1 = require(\"../OpenViduInternal/Events/StreamPropertyChangedEvent\");\nvar OpenViduError_1 = require(\"../OpenViduInternal/Enums/OpenViduError\");\nvar OpenViduLogger_1 = require(\"../OpenViduInternal/Logger/OpenViduLogger\");\n/**\n * @hidden\n */\nvar logger = OpenViduLogger_1.OpenViduLogger.getInstance();\n/**\n * **WARNING**: experimental option. This interface may change in the near future\n *\n * Video/audio filter applied to a Stream. See {@link Stream.applyFilter}\n */\nvar Filter = /** @class */function () {\n  /**\n   * @hidden\n   */\n  function Filter(type, options) {\n    /**\n     * @hidden\n     */\n    this.handlers = new Map();\n    this.type = type;\n    this.options = options;\n  }\n  /**\n   * Executes a filter method. Available methods are specific for each filter\n   *\n   * @param method Name of the method\n   * @param params Parameters of the method\n   */\n  Filter.prototype.execMethod = function (method, params) {\n    var _this = this;\n    return new Promise(function (resolve, reject) {\n      var _a;\n      logger.info('Executing filter method to stream ' + _this.stream.streamId);\n      var finalParams;\n      var successExecMethod = function (triggerEvent) {\n        logger.info('Filter method successfully executed on Stream ' + _this.stream.streamId);\n        var oldValue = Object.assign({}, _this.stream.filter);\n        _this.stream.filter.lastExecMethod = {\n          method: method,\n          params: finalParams\n        };\n        if (triggerEvent) {\n          _this.stream.session.emitEvent('streamPropertyChanged', [new StreamPropertyChangedEvent_1.StreamPropertyChangedEvent(_this.stream.session, _this.stream, 'filter', _this.stream.filter, oldValue, 'execFilterMethod')]);\n          _this.stream.streamManager.emitEvent('streamPropertyChanged', [new StreamPropertyChangedEvent_1.StreamPropertyChangedEvent(_this.stream.streamManager, _this.stream, 'filter', _this.stream.filter, oldValue, 'execFilterMethod')]);\n        }\n        return resolve();\n      };\n      if (_this.type.startsWith('VB:')) {\n        if (typeof params === 'string') {\n          try {\n            params = JSON.parse(params);\n          } catch (error) {\n            return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.VIRTUAL_BACKGROUND_ERROR, 'Wrong params syntax: ' + error));\n          }\n        }\n        finalParams = params;\n        if (method === 'update') {\n          if (!((_a = _this.stream.virtualBackgroundSinkElements) === null || _a === void 0 ? void 0 : _a.VB)) {\n            return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.VIRTUAL_BACKGROUND_ERROR, 'There is no Virtual Background filter applied'));\n          } else {\n            _this.stream.virtualBackgroundSinkElements.VB.updateValues(params).then(function () {\n              return successExecMethod(false);\n            }).catch(function (error) {\n              if (error.name === OpenViduError_1.OpenViduErrorName.VIRTUAL_BACKGROUND_ERROR) {\n                return reject(new OpenViduError_1.OpenViduError(error.name, error.message));\n              } else {\n                return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.VIRTUAL_BACKGROUND_ERROR, 'Error updating values on Virtual Background filter: ' + error));\n              }\n            });\n          }\n        } else {\n          return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.VIRTUAL_BACKGROUND_ERROR, \"Unknown Virtual Background method \\\"\".concat(method, \"\\\"\")));\n        }\n      } else {\n        var stringParams = void 0;\n        if (typeof params !== 'string') {\n          try {\n            stringParams = JSON.stringify(params);\n          } catch (error) {\n            var errorMsg = \"'params' property must be a JSON formatted object\";\n            logger.error(errorMsg);\n            return reject(errorMsg);\n          }\n        } else {\n          stringParams = params;\n        }\n        finalParams = stringParams;\n        _this.stream.session.openvidu.sendRequest('execFilterMethod', {\n          streamId: _this.stream.streamId,\n          method: method,\n          params: stringParams\n        }, function (error, response) {\n          if (error) {\n            logger.error('Error executing filter method for Stream ' + _this.stream.streamId, error);\n            if (error.code === 401) {\n              return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.OPENVIDU_PERMISSION_DENIED, \"You don't have permissions to execute a filter method\"));\n            } else {\n              return reject(error);\n            }\n          } else {\n            return successExecMethod(true);\n          }\n        });\n      }\n    });\n  };\n  /**\n   * Subscribe to certain filter event. Available events are specific for each filter\n   *\n   * @param eventType Event to which subscribe to.\n   * @param handler Function to execute upon event dispatched. It receives as parameter a {@link FilterEvent} object\n   *\n   * @returns A Promise (to which you can optionally subscribe to) that is resolved if the event listener was successfully attached to the filter and rejected with an Error object if not\n   */\n  Filter.prototype.addEventListener = function (eventType, handler) {\n    var _this = this;\n    return new Promise(function (resolve, reject) {\n      logger.info('Adding filter event listener to event ' + eventType + ' to stream ' + _this.stream.streamId);\n      _this.stream.session.openvidu.sendRequest('addFilterEventListener', {\n        streamId: _this.stream.streamId,\n        eventType: eventType\n      }, function (error, response) {\n        if (error) {\n          logger.error('Error adding filter event listener to event ' + eventType + 'for Stream ' + _this.stream.streamId, error);\n          if (error.code === 401) {\n            return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.OPENVIDU_PERMISSION_DENIED, \"You don't have permissions to add a filter event listener\"));\n          } else {\n            return reject(error);\n          }\n        } else {\n          _this.handlers.set(eventType, handler);\n          logger.info('Filter event listener to event ' + eventType + ' successfully applied on Stream ' + _this.stream.streamId);\n          return resolve();\n        }\n      });\n    });\n  };\n  /**\n   * Removes certain filter event listener previously set.\n   *\n   * @param eventType Event to unsubscribe from.\n   *\n   * @returns A Promise (to which you can optionally subscribe to) that is resolved if the event listener was successfully removed from the filter and rejected with an Error object in other case\n   */\n  Filter.prototype.removeEventListener = function (eventType) {\n    var _this = this;\n    return new Promise(function (resolve, reject) {\n      logger.info('Removing filter event listener to event ' + eventType + ' to stream ' + _this.stream.streamId);\n      _this.stream.session.openvidu.sendRequest('removeFilterEventListener', {\n        streamId: _this.stream.streamId,\n        eventType: eventType\n      }, function (error, response) {\n        if (error) {\n          logger.error('Error removing filter event listener to event ' + eventType + 'for Stream ' + _this.stream.streamId, error);\n          if (error.code === 401) {\n            return reject(new OpenViduError_1.OpenViduError(OpenViduError_1.OpenViduErrorName.OPENVIDU_PERMISSION_DENIED, \"You don't have permissions to add a filter event listener\"));\n          } else {\n            return reject(error);\n          }\n        } else {\n          _this.handlers.delete(eventType);\n          logger.info('Filter event listener to event ' + eventType + ' successfully removed on Stream ' + _this.stream.streamId);\n          return resolve();\n        }\n      });\n    });\n  };\n  return Filter;\n}();\nexports.Filter = Filter;","map":{"version":3,"names":["StreamPropertyChangedEvent_1","require","OpenViduError_1","OpenViduLogger_1","logger","OpenViduLogger","getInstance","Filter","type","options","handlers","Map","prototype","execMethod","method","params","_this","Promise","resolve","reject","info","stream","streamId","finalParams","successExecMethod","triggerEvent","oldValue","Object","assign","filter","lastExecMethod","session","emitEvent","StreamPropertyChangedEvent","streamManager","startsWith","JSON","parse","error","OpenViduError","OpenViduErrorName","VIRTUAL_BACKGROUND_ERROR","_a","virtualBackgroundSinkElements","VB","updateValues","then","catch","name","message","concat","stringParams","stringify","errorMsg","openvidu","sendRequest","response","code","OPENVIDU_PERMISSION_DENIED","addEventListener","eventType","handler","set","removeEventListener","delete","exports"],"sources":["../../src/OpenVidu/Filter.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}