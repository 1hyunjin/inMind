{"ast":null,"code":"var RpcBuilder = require('../');\nvar WebSocketWithReconnection = require('./transports/webSocketWithReconnection');\nvar OpenViduLogger = require('../../../Logger/OpenViduLogger').OpenViduLogger;\nDate.now = Date.now || function () {\n  return +new Date();\n};\nvar PING_INTERVAL = 5000;\nvar RECONNECTING = 'RECONNECTING';\nvar CONNECTED = 'CONNECTED';\nvar DISCONNECTED = 'DISCONNECTED';\nvar Logger = OpenViduLogger.getInstance();\nfunction JsonRpcClient(configuration) {\n  var self = this;\n  var wsConfig = configuration.ws;\n  var notReconnectIfNumLessThan = -1;\n  var pingNextNum = 0;\n  var enabledPings = true;\n  var pingPongStarted = false;\n  var pingInterval;\n  var status = DISCONNECTED;\n  var onreconnecting = wsConfig.onreconnecting;\n  var onreconnected = wsConfig.onreconnected;\n  var onconnected = wsConfig.onconnected;\n  var onerror = wsConfig.onerror;\n  configuration.rpc.pull = function (params, request) {\n    request.reply(null, 'push');\n  };\n  wsConfig.onreconnecting = function () {\n    Logger.debug('--------- ONRECONNECTING -----------');\n    if (status === RECONNECTING) {\n      Logger.error('Websocket already in RECONNECTING state when receiving a new ONRECONNECTING message. Ignoring it');\n      return;\n    }\n    stopPing();\n    status = RECONNECTING;\n    if (onreconnecting) {\n      onreconnecting();\n    }\n  };\n  wsConfig.onreconnected = function () {\n    Logger.debug('--------- ONRECONNECTED -----------');\n    if (status === CONNECTED) {\n      Logger.error('Websocket already in CONNECTED state when receiving a new ONRECONNECTED message. Ignoring it');\n      return;\n    }\n    status = CONNECTED;\n    updateNotReconnectIfLessThan();\n    if (onreconnected) {\n      onreconnected();\n    }\n  };\n  wsConfig.onconnected = function () {\n    Logger.debug('--------- ONCONNECTED -----------');\n    if (status === CONNECTED) {\n      Logger.error('Websocket already in CONNECTED state when receiving a new ONCONNECTED message. Ignoring it');\n      return;\n    }\n    status = CONNECTED;\n    enabledPings = true;\n    usePing();\n    if (onconnected) {\n      onconnected();\n    }\n  };\n  wsConfig.onerror = function (error) {\n    Logger.debug('--------- ONERROR -----------');\n    status = DISCONNECTED;\n    stopPing();\n    if (onerror) {\n      onerror(error);\n    }\n  };\n  var ws = new WebSocketWithReconnection(wsConfig);\n  Logger.debug('Connecting websocket to URI: ' + wsConfig.uri);\n  var rpcBuilderOptions = {\n    request_timeout: configuration.rpc.requestTimeout,\n    ping_request_timeout: configuration.rpc.heartbeatRequestTimeout\n  };\n  var rpc = new RpcBuilder(RpcBuilder.packers.JsonRPC, rpcBuilderOptions, ws, function (request) {\n    Logger.debug('Received request: ' + JSON.stringify(request));\n    try {\n      var func = configuration.rpc[request.method];\n      if (func === undefined) {\n        Logger.error('Method ' + request.method + ' not registered in client');\n      } else {\n        func(request.params, request);\n      }\n    } catch (err) {\n      Logger.error('Exception processing request: ' + JSON.stringify(request));\n      Logger.error(err);\n    }\n  });\n  this.send = function (method, params, callback) {\n    var requestTime = Date.now();\n    rpc.encode(method, params, function (error, result) {\n      if (error) {\n        try {\n          Logger.error('ERROR:' + error.message + ' in Request: method:' + method + ' params:' + JSON.stringify(params) + ' request:' + error.request);\n          if (error.data) {\n            Logger.error('ERROR DATA:' + JSON.stringify(error.data));\n          }\n        } catch (e) {}\n        error.requestTime = requestTime;\n      }\n      if (callback) {\n        if (result != undefined && result.value !== 'pong') {\n          Logger.debug('Response: ' + JSON.stringify(result));\n        }\n        callback(error, result);\n      }\n    });\n  };\n  function updateNotReconnectIfLessThan() {\n    Logger.debug('notReconnectIfNumLessThan = ' + pingNextNum + ' (old=' + notReconnectIfNumLessThan + ')');\n    notReconnectIfNumLessThan = pingNextNum;\n  }\n  function sendPing() {\n    if (enabledPings) {\n      var params = null;\n      if (pingNextNum == 0 || pingNextNum == notReconnectIfNumLessThan) {\n        params = {\n          interval: configuration.heartbeat || PING_INTERVAL\n        };\n      }\n      pingNextNum++;\n      self.send('ping', params, function (pingNum) {\n        return function (error, result) {\n          if (error) {\n            Logger.debug('Error in ping request #' + pingNum + ' (' + error.message + ')');\n            if (pingNum > notReconnectIfNumLessThan) {\n              enabledPings = false;\n              updateNotReconnectIfLessThan();\n              Logger.debug('Server did not respond to ping message #' + pingNum + '. Reconnecting... ');\n              ws.reconnectWs();\n            }\n          }\n        };\n      }(pingNextNum));\n    } else {\n      Logger.debug('Trying to send ping, but ping is not enabled');\n    }\n  }\n  function usePing() {\n    if (!pingPongStarted) {\n      Logger.debug('Starting ping (if configured)');\n      pingPongStarted = true;\n      if (configuration.heartbeat != undefined) {\n        pingInterval = setInterval(sendPing, configuration.heartbeat);\n        sendPing();\n      }\n    }\n  }\n  function stopPing() {\n    clearInterval(pingInterval);\n    pingPongStarted = false;\n    enabledPings = false;\n    pingNextNum = -1;\n    rpc.cancel();\n  }\n  this.close = function (code, reason) {\n    Logger.debug('Closing  with code: ' + code + ' because: ' + reason);\n    if (pingInterval != undefined) {\n      Logger.debug('Clearing ping interval');\n      clearInterval(pingInterval);\n    }\n    pingPongStarted = false;\n    enabledPings = false;\n    ws.close(code, reason);\n  };\n  this.reconnect = function () {\n    ws.reconnectWs();\n  };\n  this.resetPing = function () {\n    enabledPings = true;\n    pingNextNum = 0;\n    usePing();\n  };\n  this.getReadyState = function () {\n    return ws.getReadyState();\n  };\n}\nmodule.exports = JsonRpcClient;","map":{"version":3,"names":["RpcBuilder","require","WebSocketWithReconnection","OpenViduLogger","Date","now","PING_INTERVAL","RECONNECTING","CONNECTED","DISCONNECTED","Logger","getInstance","JsonRpcClient","configuration","self","wsConfig","ws","notReconnectIfNumLessThan","pingNextNum","enabledPings","pingPongStarted","pingInterval","status","onreconnecting","onreconnected","onconnected","onerror","rpc","pull","params","request","reply","debug","error","stopPing","updateNotReconnectIfLessThan","usePing","uri","rpcBuilderOptions","request_timeout","requestTimeout","ping_request_timeout","heartbeatRequestTimeout","packers","JsonRPC","JSON","stringify","func","method","undefined","err","send","callback","requestTime","encode","result","message","data","e","value","sendPing","interval","heartbeat","pingNum","reconnectWs","setInterval","clearInterval","cancel","close","code","reason","reconnect","resetPing","getReadyState","module","exports"],"sources":["../../../../../src/OpenViduInternal/KurentoUtils/kurento-jsonrpc/clients/jsonrpcclient.js"],"sourcesContent":[null],"mappings":"AAiBA,IAAIA,UAAU,GAAGC,OAAO,CAAC,KAAK,CAAC;AAC/B,IAAIC,yBAAyB,GAAGD,OAAO,CAAC,wCAAwC,CAAC;AACjF,IAAIE,cAAc,GAAGF,OAAO,CAAC,gCAAgC,CAAC,CAACE,cAAc;AAE7EC,IAAI,CAACC,GAAG,GACJD,IAAI,CAACC,GAAG,IACR;EACI,OAAO,CAAC,IAAID,IAAI,EAAE;AACtB,CAAC;AAEL,IAAIE,aAAa,GAAG,IAAI;AAExB,IAAIC,YAAY,GAAG,cAAc;AACjC,IAAIC,SAAS,GAAG,WAAW;AAC3B,IAAIC,YAAY,GAAG,cAAc;AAEjC,IAAIC,MAAM,GAAGP,cAAc,CAACQ,WAAW,EAAE;AAqBzC,SAASC,aAAaA,CAACC,aAAa;EAChC,IAAIC,IAAI,GAAG,IAAI;EAEf,IAAIC,QAAQ,GAAGF,aAAa,CAACG,EAAE;EAE/B,IAAIC,yBAAyB,GAAG,CAAC,CAAC;EAElC,IAAIC,WAAW,GAAG,CAAC;EACnB,IAAIC,YAAY,GAAG,IAAI;EACvB,IAAIC,eAAe,GAAG,KAAK;EAC3B,IAAIC,YAAY;EAEhB,IAAIC,MAAM,GAAGb,YAAY;EAEzB,IAAIc,cAAc,GAAGR,QAAQ,CAACQ,cAAc;EAC5C,IAAIC,aAAa,GAAGT,QAAQ,CAACS,aAAa;EAC1C,IAAIC,WAAW,GAAGV,QAAQ,CAACU,WAAW;EACtC,IAAIC,OAAO,GAAGX,QAAQ,CAACW,OAAO;EAE9Bb,aAAa,CAACc,GAAG,CAACC,IAAI,GAAG,UAAUC,MAAM,EAAEC,OAAO;IAC9CA,OAAO,CAACC,KAAK,CAAC,IAAI,EAAE,MAAM,CAAC;EAC/B,CAAC;EAEDhB,QAAQ,CAACQ,cAAc,GAAG;IACtBb,MAAM,CAACsB,KAAK,CAAC,sCAAsC,CAAC;IACpD,IAAIV,MAAM,KAAKf,YAAY,EAAE;MACzBG,MAAM,CAACuB,KAAK,CAAC,kGAAkG,CAAC;MAChH;;IAGJC,QAAQ,EAAE;IAEVZ,MAAM,GAAGf,YAAY;IACrB,IAAIgB,cAAc,EAAE;MAChBA,cAAc,EAAE;;EAExB,CAAC;EAEDR,QAAQ,CAACS,aAAa,GAAG;IACrBd,MAAM,CAACsB,KAAK,CAAC,qCAAqC,CAAC;IACnD,IAAIV,MAAM,KAAKd,SAAS,EAAE;MACtBE,MAAM,CAACuB,KAAK,CAAC,8FAA8F,CAAC;MAC5G;;IAEJX,MAAM,GAAGd,SAAS;IAElB2B,4BAA4B,EAAE;IAE9B,IAAIX,aAAa,EAAE;MACfA,aAAa,EAAE;;EAEvB,CAAC;EAEDT,QAAQ,CAACU,WAAW,GAAG;IACnBf,MAAM,CAACsB,KAAK,CAAC,mCAAmC,CAAC;IACjD,IAAIV,MAAM,KAAKd,SAAS,EAAE;MACtBE,MAAM,CAACuB,KAAK,CAAC,4FAA4F,CAAC;MAC1G;;IAEJX,MAAM,GAAGd,SAAS;IAElBW,YAAY,GAAG,IAAI;IACnBiB,OAAO,EAAE;IAET,IAAIX,WAAW,EAAE;MACbA,WAAW,EAAE;;EAErB,CAAC;EAEDV,QAAQ,CAACW,OAAO,GAAG,UAAUO,KAAK;IAC9BvB,MAAM,CAACsB,KAAK,CAAC,+BAA+B,CAAC;IAE7CV,MAAM,GAAGb,YAAY;IAErByB,QAAQ,EAAE;IAEV,IAAIR,OAAO,EAAE;MACTA,OAAO,CAACO,KAAK,CAAC;;EAEtB,CAAC;EAED,IAAIjB,EAAE,GAAG,IAAId,yBAAyB,CAACa,QAAQ,CAAC;EAEhDL,MAAM,CAACsB,KAAK,CAAC,+BAA+B,GAAGjB,QAAQ,CAACsB,GAAG,CAAC;EAE5D,IAAIC,iBAAiB,GAAG;IACpBC,eAAe,EAAE1B,aAAa,CAACc,GAAG,CAACa,cAAc;IACjDC,oBAAoB,EAAE5B,aAAa,CAACc,GAAG,CAACe;GAC3C;EAED,IAAIf,GAAG,GAAG,IAAI3B,UAAU,CAACA,UAAU,CAAC2C,OAAO,CAACC,OAAO,EAAEN,iBAAiB,EAAEtB,EAAE,EAAE,UAAUc,OAAO;IACzFpB,MAAM,CAACsB,KAAK,CAAC,oBAAoB,GAAGa,IAAI,CAACC,SAAS,CAAChB,OAAO,CAAC,CAAC;IAE5D,IAAI;MACA,IAAIiB,IAAI,GAAGlC,aAAa,CAACc,GAAG,CAACG,OAAO,CAACkB,MAAM,CAAC;MAE5C,IAAID,IAAI,KAAKE,SAAS,EAAE;QACpBvC,MAAM,CAACuB,KAAK,CAAC,SAAS,GAAGH,OAAO,CAACkB,MAAM,GAAG,2BAA2B,CAAC;OACzE,MAAM;QACHD,IAAI,CAACjB,OAAO,CAACD,MAAM,EAAEC,OAAO,CAAC;;KAEpC,CAAC,OAAOoB,GAAG,EAAE;MACVxC,MAAM,CAACuB,KAAK,CAAC,gCAAgC,GAAGY,IAAI,CAACC,SAAS,CAAChB,OAAO,CAAC,CAAC;MACxEpB,MAAM,CAACuB,KAAK,CAACiB,GAAG,CAAC;;EAEzB,CAAC,CAAC;EAEF,IAAI,CAACC,IAAI,GAAG,UAAUH,MAAM,EAAEnB,MAAM,EAAEuB,QAAQ;IAC1C,IAAIC,WAAW,GAAGjD,IAAI,CAACC,GAAG,EAAE;IAE5BsB,GAAG,CAAC2B,MAAM,CAACN,MAAM,EAAEnB,MAAM,EAAE,UAAUI,KAAK,EAAEsB,MAAM;MAC9C,IAAItB,KAAK,EAAE;QACP,IAAI;UACAvB,MAAM,CAACuB,KAAK,CACR,QAAQ,GACJA,KAAK,CAACuB,OAAO,GACb,sBAAsB,GACtBR,MAAM,GACN,UAAU,GACVH,IAAI,CAACC,SAAS,CAACjB,MAAM,CAAC,GACtB,WAAW,GACXI,KAAK,CAACH,OAAO,CACpB;UACD,IAAIG,KAAK,CAACwB,IAAI,EAAE;YACZ/C,MAAM,CAACuB,KAAK,CAAC,aAAa,GAAGY,IAAI,CAACC,SAAS,CAACb,KAAK,CAACwB,IAAI,CAAC,CAAC;;SAE/D,CAAC,OAAOC,CAAC,EAAE;QACZzB,KAAK,CAACoB,WAAW,GAAGA,WAAW;;MAEnC,IAAID,QAAQ,EAAE;QACV,IAAIG,MAAM,IAAIN,SAAS,IAAIM,MAAM,CAACI,KAAK,KAAK,MAAM,EAAE;UAChDjD,MAAM,CAACsB,KAAK,CAAC,YAAY,GAAGa,IAAI,CAACC,SAAS,CAACS,MAAM,CAAC,CAAC;;QAEvDH,QAAQ,CAACnB,KAAK,EAAEsB,MAAM,CAAC;;IAE/B,CAAC,CAAC;EACN,CAAC;EAED,SAASpB,4BAA4BA,CAAA;IACjCzB,MAAM,CAACsB,KAAK,CAAC,8BAA8B,GAAGd,WAAW,GAAG,QAAQ,GAAGD,yBAAyB,GAAG,GAAG,CAAC;IACvGA,yBAAyB,GAAGC,WAAW;EAC3C;EAEA,SAAS0C,QAAQA,CAAA;IACb,IAAIzC,YAAY,EAAE;MACd,IAAIU,MAAM,GAAG,IAAI;MACjB,IAAIX,WAAW,IAAI,CAAC,IAAIA,WAAW,IAAID,yBAAyB,EAAE;QAC9DY,MAAM,GAAG;UACLgC,QAAQ,EAAEhD,aAAa,CAACiD,SAAS,IAAIxD;SACxC;;MAELY,WAAW,EAAE;MAEbJ,IAAI,CAACqC,IAAI,CACL,MAAM,EACNtB,MAAM,EACL,UAAUkC,OAAO;QACd,OAAO,UAAU9B,KAAK,EAAEsB,MAAM;UAC1B,IAAItB,KAAK,EAAE;YACPvB,MAAM,CAACsB,KAAK,CAAC,yBAAyB,GAAG+B,OAAO,GAAG,IAAI,GAAG9B,KAAK,CAACuB,OAAO,GAAG,GAAG,CAAC;YAC9E,IAAIO,OAAO,GAAG9C,yBAAyB,EAAE;cACrCE,YAAY,GAAG,KAAK;cACpBgB,4BAA4B,EAAE;cAC9BzB,MAAM,CAACsB,KAAK,CAAC,0CAA0C,GAAG+B,OAAO,GAAG,oBAAoB,CAAC;cACzF/C,EAAE,CAACgD,WAAW,EAAE;;;QAG5B,CAAC;MACL,CAAC,CAAE9C,WAAW,CAAC,CAClB;KACJ,MAAM;MACHR,MAAM,CAACsB,KAAK,CAAC,8CAA8C,CAAC;;EAEpE;EAMA,SAASI,OAAOA,CAAA;IACZ,IAAI,CAAChB,eAAe,EAAE;MAClBV,MAAM,CAACsB,KAAK,CAAC,+BAA+B,CAAC;MAC7CZ,eAAe,GAAG,IAAI;MAEtB,IAAIP,aAAa,CAACiD,SAAS,IAAIb,SAAS,EAAE;QACtC5B,YAAY,GAAG4C,WAAW,CAACL,QAAQ,EAAE/C,aAAa,CAACiD,SAAS,CAAC;QAC7DF,QAAQ,EAAE;;;EAGtB;EAEA,SAAS1B,QAAQA,CAAA;IACbgC,aAAa,CAAC7C,YAAY,CAAC;IAC3BD,eAAe,GAAG,KAAK;IACvBD,YAAY,GAAG,KAAK;IACpBD,WAAW,GAAG,CAAC,CAAC;IAChBS,GAAG,CAACwC,MAAM,EAAE;EAChB;EAEA,IAAI,CAACC,KAAK,GAAG,UAAUC,IAAI,EAAEC,MAAM;IAC/B5D,MAAM,CAACsB,KAAK,CAAC,sBAAsB,GAAGqC,IAAI,GAAG,YAAY,GAAGC,MAAM,CAAC;IACnE,IAAIjD,YAAY,IAAI4B,SAAS,EAAE;MAC3BvC,MAAM,CAACsB,KAAK,CAAC,wBAAwB,CAAC;MACtCkC,aAAa,CAAC7C,YAAY,CAAC;;IAE/BD,eAAe,GAAG,KAAK;IACvBD,YAAY,GAAG,KAAK;IACpBH,EAAE,CAACoD,KAAK,CAACC,IAAI,EAAEC,MAAM,CAAC;EAC1B,CAAC;EAED,IAAI,CAACC,SAAS,GAAG;IACbvD,EAAE,CAACgD,WAAW,EAAE;EACpB,CAAC;EAED,IAAI,CAACQ,SAAS,GAAG;IACbrD,YAAY,GAAG,IAAI;IACnBD,WAAW,GAAG,CAAC;IACfkB,OAAO,EAAE;EACb,CAAC;EAED,IAAI,CAACqC,aAAa,GAAG;IACjB,OAAOzD,EAAE,CAACyD,aAAa,EAAE;EAC7B,CAAC;AACL;AAEAC,MAAM,CAACC,OAAO,GAAG/D,aAAa","ignoreList":[]},"metadata":{},"sourceType":"script"}